name: Agency UI - Fail-Fast Validation

on:
  push:
    branches: [ feat/agency-enterprise-ui-dash ]
  pull_request:
    branches: [ feat/agency-enterprise-ui-dash, main ]

jobs:
  fail-fast-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ”§ Install dependencies
      run: npm ci
      
    - name: ğŸ¯ CRITICAL: Schema Drift Detection
      run: |
        echo "ğŸ” Running schema drift detection - MUST PASS"
        npm run check-schema-drift
        echo "âœ… Schema drift check passed"
        
    - name: ğŸ“Š TypeScript Strict Compilation  
      run: |
        echo "ğŸ”¨ Running TypeScript strict compilation"
        npx tsc --noEmit --strict
        echo "âœ… TypeScript compilation passed"
        
    - name: ğŸ—ï¸ Production Build Validation
      run: |
        echo "ğŸš€ Testing production build"
        npm run build
        echo "âœ… Production build successful"
        
    - name: ğŸ§ª Full Test Suite
      run: |
        echo "ğŸ§ª Running complete test suite"
        npm run test:run
        echo "âœ… All tests passed"
        
    - name: ğŸ” Mock Data Import Audit
      run: |
        echo "ğŸ•µï¸ Auditing for hardcoded mock data"
        npm run audit:mock-imports || echo "âš ï¸ Mock data audit warnings (non-blocking)"
        
    - name: ğŸ¤– Agent Contract Validation
      run: |
        echo "ğŸ¤– Validating AI agent contracts"
        npm run agents:validate-all || echo "âš ï¸ Agent validation (if available)"
        
    - name: ğŸ“ˆ Comprehensive Startup Check
      run: |
        echo "ğŸ“ˆ Running comprehensive system validation"
        node scripts/comprehensive-startup-check.js
        
    - name: ğŸ¯ UI/UX Component Validation
      run: |
        echo "ğŸ¨ Validating UI components (future)"
        # npm run test -- src/__tests__/ui* || echo "âš ï¸ UI tests (when implemented)"
        echo "âœ… UI validation placeholder"
        
  branch-protection-status:
    runs-on: ubuntu-latest
    needs: fail-fast-validation
    if: always()
    
    steps:
    - name: ğŸ›¡ï¸ Branch Protection Summary
      run: |
        echo "ğŸ›¡ï¸ AGENCY UI BRANCH PROTECTION SUMMARY"
        echo "======================================"
        echo ""
        if [ "${{ needs.fail-fast-validation.result }}" == "success" ]; then
          echo "âœ… ALL VALIDATIONS PASSED"
          echo "ğŸš€ Branch is safe for merge to main"
          echo "ğŸ”’ No schema drift detected"
          echo "ğŸ—ï¸ Production build validated"
          echo "ğŸ§ª All tests passing"
        else
          echo "âŒ VALIDATION FAILED"
          echo "ğŸš« Branch BLOCKED from merge"
          echo "ğŸ”§ Fix issues before proceeding"
          exit 1
        fi

# Prevent any deployment on this branch
  prevent-deployment:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/feat/agency-enterprise-ui-dash'
    
    steps:
    - name: ğŸš« Block Deployment
      run: |
        echo "ğŸš« DEPLOYMENT BLOCKED on agency UI branch"
        echo "This branch is for development only"
        echo "Merge to main branch for production deployment"